
<@row>
    <@columns>
        <@appointmentTabs tab="specificWeek" form=appointmentform />
    </@columns>
</@row>

<@modal id='commentModal'>
    <@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
    <@modalBody>
        <@getCommentForm "comment" "startingValidityDate" "endingValidityDate" "idStartingTime" "idEndingTime" "doAddComment" id_form />
    </@modalBody>
    <@modalFooter>
        <@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
    </@modalFooter>
</@modal>

<@modal id='modify-comment'>
    <@modalHeader modalTitle='#i18n{appointment.modify_comment.pageTitle}' />
    <@modalBody>
        <@getCommentForm "comment" "modifyStartingValidityDate" "modifyEndingValidityDate" "idModifyStartingTime" "idModifyEndingTime" "doModifyComment" id_form />
    </@modalBody>
    <@modalFooter>
        <@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
    </@modalFooter>
</@modal>

<@modal id='updatePlanningSlot'>
    <@modalBody>
        <@tform action='jsp/admin/plugins/appointment/ManageSpecificWeek.jsp'>					
            <input type="hidden" name="action" value="doModifyListSlot" >
            <input type="hidden" name="id_form" value="${appointmentform.idForm}">
            <input type="hidden" id="date_of_display" name="date_of_display" value="${date_of_display}" >
            <input type="hidden" id="slotData" name="slotsData" value=''>	
            <input type="hidden" id="capacity" name="capacity" value="new_cap">		
            <@formGroup labelKey='#i18n{appointment.modifySlot.labelDate}'>
                <@staticText id="dtSlot"></@staticText>
            </@formGroup>
            <@formGroup labelFor='is_open' labelKey='#i18n{appointment.labelOpen}' helpKey='#i18n{appointment.modifySlot.labelOpenHelp}' mandatory=true>
                <@checkBox name='is_open' id='is_open' value='true' checked=true />
            </@formGroup>
            <@formGroup labelKey='#i18n{appointment.modifySlot.labelMaxCapacityForThisSlot}' mandatory=true>
                <@input type='number' id='max_capacity' name='max_capacity' value='' maxlength=3 />	
            </@formGroup>
            <@formGroup labelKey='#i18n{appointment.model.entity.appointmentform.attribute.timeStart}'>
                <@staticText id='timeStart'></@staticText>
            </@formGroup>
            <@formGroup labelFor='time_end' labelKey='#i18n{appointment.model.entity.appointmentform.attribute.timeEnd}' helpKey='#i18n{appointment.modifySlot.helpModifyEndSlot}' mandatory=true>
                <@inputGroup>
                    <@input type='text' name='ending_time' id='ending_time' value='' />
                    <@inputGroupItem type='addon'>
                        <@icon style='clock-o' />
                    </@inputGroupItem>
                </@inputGroup>
            </@formGroup>
            <@formGroup labelFor='shift_slot'>
                <@radioButton labelFor='shift_slot' labelKey='#i18n{appointment.modifySlot.notShiftSlot}' name='shift_slot' id='shift_slot' checked=true value='false' />
                <@radioButton labelFor='shift_slot' labelKey='#i18n{appointment.modifySlot.shiftSlot}' name='shift_slot' value='true' />
            </@formGroup>
            <@formGroup>
                <@button type='submit' buttonIcon='check' name='modify' id='modify' title='#i18n{portal.util.labelModify}' />
                <@button color='secondary' title='#i18n{portal.util.labelBack}' params=' data-dismiss="modal" aria-label="Close"' />
            </@formGroup>
        </@tform>
    </@modalBody>
</@modal>

<@modal id='updatePlanningMultiSlot'>
    <@modalBody>
        <@tform action="jsp/admin/plugins/appointment/ManageSpecificWeek.jsp">
            <input type="hidden" name="action" value="doModifyListSlot" >
            <input type="hidden" name="id_form" value="${appointmentform.idForm}">
            <input type="hidden" id="slotsData" name="slotsData" value=''>
            <input type="hidden" id="date_of_display_multi" name="date_of_display" value="${date_of_display}" >	
            <@formGroup labelFor='is_open' labelKey='#i18n{appointment.labelOpen}' helpKey='#i18n{appointment.modifySlot.labelOpenHelp}' mandatory=true>
                <@checkBox name='is_open' id='is_open_multi' value='true' checked=true />
            </@formGroup>
            <@row>
            <@columns>
                <@formGroup labelFor='shift_slot'>
                    <@radioButton labelFor='var_cap' labelKey='Variation de capacité' name='capacity' id='var_cap' checked=true value='var_cap' />
                    <@radioButton labelFor='new_cap' labelKey='Nouvelle capacité' name='capacity' id='new_cap' value='new_cap' />
                    <@input type='number' id='newCapacity' name='max_capacity' value='0' min=-99 max=99 />
                </@formGroup>
            </@columns>
            </@row>
            <@formGroup rows=1>
                <@button type='submit' color='primary' title='Enregistrer' />
                <@button color='secondary' title='Annuler' params=' data-dismiss="modal" aria-label="Close"' />
            </@formGroup>
        </@tform>
    </@modalBody>
</@modal> 

<@modal id='commentModal'>
    <@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@modal id='modify-comment'>
	<@modalHeader modalTitle='#i18n{appointment.modify_comment.pageTitle}' />
	<@modalBody>
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<script type="text/javascript">
    var slotDuration = '${min_duration}';
    var minTime = '${min_time}';
    var maxTime = '${max_time}';
    var endingDateOfDisplay = '${ending_date_of_display}';
    var dow = [<#if dow??><#list dow as day>'${day}',</#list></#if>];
    var eventUrl = 'jsp/admin/plugins/appointment/ManageSpecificWeek.jsp?view=viewModifySlot&id_form=${appointmentform.idForm}';
    var events = [
    <#if events??>
        <#list events as event>
            {
                title   : 'Capacit\u00e9 max : ' + '${event.maxCapacity}' + <#if event.isSpecific>' (*)'<#else>''</#if>,
                start   : '${event.startingDateTime}',
                end     : '${event.endingDateTime}',
                id      : '${event.idSlot}',
                color   : <#if event.isOpen>'transparent'<#else>'#bebebe'</#if>,
                textColor: '#2c2c2d',
                url     : eventUrl + '&id_slot=${event.idSlot}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}&is_open=<#if event.isOpen>true<#else>false</#if>&is_specific=<#if event.isSpecific>true<#else>false</#if>&max_capacity=${event.maxCapacity}',
                backgroundColor : <#if event.isOpen & !event.isPassed>'white'<#else>'#bebebe'</#if>,
                borderColor : '#bebebe',
                isOpen : '${event.isOpen?c}',
                isSpecific : '${event.isSpecific?c}',
                maxCapacity: '${event.maxCapacity}',
                idForm: '${event.idForm}',
                date: '${event.date}',
            },
        </#list>
    </#if>
    <#if comment_events??>
        <#list comment_events as comment_event>
        {
            "title" : "${comment_event.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}",
            "start" : "${comment_event.startingValidityDate}",
            "end" : "${comment_event.calendarAllDaySlotEnd}",
            "validity_end" : "${comment_event.endingValidityDate}",
            "start_time" : "${comment_event.startingValidityTime!}",
            "end_time" : "${comment_event.endingValidityTime!}",
            "id" : "${comment_event.id}",
            "creator_user" : "${comment_event.creatorUserName!''}",
            "creation_date" : "${comment_event.creationDate?date.xs!''}",
            "type": "comment"
        },
        </#list>
    </#if>
    ];
    var defaultDate = '${date_of_display}';
    $( function() {
        $('#calendar').fullCalendar({
            displayEventTime: false,
            buttonText : {
                prev : '#i18n{appointment.appointmentApp.previousWeek}',
                next : '#i18n{appointment.appointmentApp.nextWeek}',
            },
            defaultDate: defaultDate,
            defaultView: 'agendaWeek',
            height: 'auto',
            locale: 'fr',
            themeSystem: 'jquery-ui',
            customButtons: {
                datePicker: {
                    text: '#i18n{appointment.appointmentCalendar.labelChooseDate}',
                    click: function () {
                        var $btnCustom = $('.fc-datePicker-button'); // name of custom  button in the generated code
                        $btnCustom.after('<input type="text" id="hiddenDate" class="datepicker"/>');
                        $("#hiddenDate").datepicker({
                            language:'fr',
                            showOn: "button",
                            dateFormat:"yy-mm-dd",
                            autoclose: true,
                            orientation: "bottom"
                        });
                        var $btnDatepicker = $(".ui-datepicker-trigger"); // name of the generated datepicker UI 
                        //Below are required for manipulating dynamically created datepicker on custom button click
                        $("#hiddenDate").focus().hide();
                        $btnDatepicker.trigger("click"); //dynamically generated button for datepicker when clicked on input textbox
                        $btnDatepicker.hide();
                        $btnDatepicker.remove();
                        $("input.datepicker").not(":first").remove();//dynamically appended every time on custom button click
                        $("#hiddenDate").change(function () {
                            $('#calendar').fullCalendar('gotoDate', moment($("#hiddenDate").val(),'DD-MM-YYYY'));
                        });
                    }
                }
            },
            // header
            header: {
                left: 'prev',
                center: 'today, datePicker, title',
                right: 'next'
            },
            columnHeaderHtml: function(mom) {
                return mom.format('dddd') + '</br>' + mom.format('LL');
            },
            slotLabelFormat: 'H:mm',
            slotLabelInterval: slotDuration,
            slotDuration: slotDuration,
            allDaySlot: true,
            minTime: minTime,
            maxTime: maxTime,
            businessHours: {
                start: minTime,
                end: maxTime,
                dow: dow
            },
            eventClick: function(calEvent, jsEvent, view) {
            	if(calEvent.type != "comment")
            	{
            	    location.href = calEvent.url;
            	    //return false;
            	}
            },
            events: events,
            eventRender: function(event, element) {
                var $title = element.find( '.fc-title' );
                $(element).addClass( event.customClass );
                $(element).attr( 'data-event', '"idSlot":"' + event.id +'","startingDateTime":"' + event.start.toISOString()+ '","startingTime":"' + event.start.format('HH:mm') + '","endingDateTime":"' + event.end.toISOString() + '","endingTime":"' + event.end.format('HH:mm')+ '","isOpen":"' + event.isOpen + '","idForm":"' + event.idForm +'","date":"' + event.date + '","isSpecific":"' + event.isSpecific + '","maxCapacity":"' + event.maxCapacity + '"' );
           
                if ( event.customStyle !='' ){
                    $(element).css( 'background', event.customStyle );
                }
                
                $title.html( $title.text() );
                
                $(element).contextmenu(function() {
                    return false;
                });

                var json = {
                    "container": "body",
                    "placement" : "bottom",
                    "html" : true,
                    "trigger" : "hover"
                };

                if( event.type == "comment" ){
                    if ( event.validity_end == null || event.validity_end == undefined ){
                        labelEventDate='Le ' + event.start.format('ddd DD/MM');
                    } else {
                        moment.locale("${locale}");
                        labelEventDate = 'Du ' + event.start.format('ddd DD/MM') + ' ' + event.start_time + ' au '+ moment(event.validity_end).format('ddd DD/MM') + ' ' + event.end_time;
                    }
                    json.content = '<p>' + labelEventDate +'<p><hr>'+ event.title + '<hr><p><strong>Par ' + event.creator_user + '</strong> le <time>' + event.creation_date + '</time>' ;
                } else {
                    json.content = event.start.format('ddd DD/MM')+"</center>" + "<center><b>" + event.start.format('HH:mm') + "</b> - <b>" + event.end.format('HH:mm')+"</b></center>";
                }

                $(element).popover( json );
                
                if(event.type == "comment" ){
                    var fcTitle = element.find('.fc-title p');
                    fcTitle.prepend( '[' + event.creator_user + '] ');
                    element.append( "<div class='btn-comments'><a href='' class='toggle-modify-comment' data-json='{\"id_comment\": \"" + event.id + "\", \"comment_text\": \"" + event.title.replace(/"/g,'\\"') + "\", \"comment_start\":\"" + event.start.format('YYYY-MM-DD') + "\", \"comment_start_time\":\"" + event.start_time + "\", \"comment_end\":\"" + event.validity_end + "\", \"comment_end_time\":\"" + event.end_time + "\" }' ><i class='fa fa-pencil fa-fw'></i></a><a href='jsp/admin/plugins/appointment/Comments.jsp?action=confirmRemoveComment&id_comment=" + event.id + "' class='closeon text-danger'><i class='fa fa-remove fa-fw'></i></a></div>" );
                }
            },
            viewRender: function(view, element) {
                var minDate = moment();
                var maxDate = moment(endingDateOfDisplay);
                // Past
                if (minDate >= view.start && minDate <= view.end || view.end <= minDate) {
                    $(".fc-prev-button").prop('disabled', true);
                    $(".fc-prev-button").addClass('fc-state-disabled'); 
                } else {
                    $(".fc-prev-button").removeClass('fc-state-disabled'); 
                    $(".fc-prev-button").prop('disabled', false);
                }
                // Future
                if (maxDate >= view.start && maxDate <= view.end || maxDate <= view.start) {
                    $(".fc-next-button").prop('disabled', true);
                    $(".fc-next-button").addClass('fc-state-disabled');
                } else {
                    $(".fc-next-button").removeClass('fc-state-disabled');
                    $(".fc-next-button").prop('disabled', false); 
                }
            },
            eventAfterAllRender: function(view) {
                $('.fc-event').css('cursor', 'pointer');
                $('.fc-next-button').attr('class', 'fc-next-button btn btn-primary btn-sm');
                $('.fc-prev-button').attr('class', 'fc-prev-button btn btn-primary btn-sm');
                $('.fc-today-button').attr('class', 'fc-today-button btn btn-primary btn-sm');
                $('.fc-datePicker-button').attr('class', 'fc-datePicker-button btn btn-primary btn-sm');
                
                $('#toggle-add-comment').clone().appendTo(".fc-body .ui-widget-content .fc-day-grid .fc-content-skeleton .fc-axis");
                $('.fc-body .ui-widget-content .fc-day-grid .fc-content-skeleton .fc-axis:first').css('position', 'relative');
		
                $('#toggle-add-comment').remove();
                $('#toggle-add-comment > span').removeClass('hidden');
                var tgc = $('#toggle-add-comment').find('body');
                tgc.click(function(ev) {
                    $( "#commentModal" ).modal('show');
                });
                $('.toggle-modify-comment').click(function(event) {
                    event.preventDefault();
                    var formValues = JSON.parse( $(this).attr( "data-json" ) );
                    $("#modify-comment input[name='id_comment']").val( formValues.id_comment );
                    tinyMCE.activeEditor.setContent( formValues.comment_text );
                    $( "#modify-comment input[name='startingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_start ) );
                    $( "#modify-comment input[name='endingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_end ) );
                    $( "#modify-comment input[name='startingValidityTime']" ).val( formValues.comment_start_time );
                    $( "#modify-comment input[name='endingValidityTime']" ).val( formValues.comment_end_time );
                    $( "#modify-comment" ).modal('show');
                });
                /* Event selection          */ 
                var eventIdx=0, eventData='',evtData='';
                $( ".fc-content-skeleton" ).not(":has(.btn-comments)").selectable({
                    filter: ".fc-time-grid-event.fc-v-event",
                    selecting: function( event, ui ) {
                        eventIdx++;
                    },
                    unselecting: function( event, ui ) {
                        eventIdx--;
                    },
                    stop: function() {
                        $( ".ui-selected", this ).each( function() {
                            console.log( eventData );
                            if ( eventIdx > 1 ){
                                eventData += '{' + $(this).data('event') + '},' ;
                                const events =  JSON.stringify( eventData );
                                evtData='['+eventData.slice(0, -1)+']'
                                const evt = JSON.parse(evtData); 
                                $('#slotsData').val( evtData);
                                $('#date_of_display_multi').val( moment(evt[0].startingDateTime).format('YYYY-MM-DD') );
                                $('#updatePlanningMultiSlot').modal('show');
                            } else {
                                eventData ='{' + $(this).data('event') + '}';  
                                const events = JSON.stringify(eventData); 
                                evtData= '['+eventData+']';
                                $('#slotData').val( evtData );
                                const evt = JSON.parse(eventData); 
                                const isOpen = JSON.parse( evt.isOpen )
                                $('#is_open').prop( "checked", isOpen );
                                $('#max_capacity').val( evt.maxCapacity );
                                $('#dtSlot').text( moment(evt.startingDateTime).format('DD/MM/YYYY') );
                                $('#date_of_display').val( moment(evt.startingDateTime).format('YYYY-MM-DD') );
                                $('#timeStart').text( evt.startingTime );
                                $('#ending_time').val( evt.endingTime );
                                $('#updatePlanningSlot').modal('show');
                            }
                        });
                        eventData='';
                    }
                });

                $(".fc-view.fc-agendaWeek-view.fc-agenda-view .fc-body .ui-widget-content .fc-day-grid .fc-bg .fc-axis.ui-widget-content").html( '' );
            },
        });
       
        $('#new_cap').click(function(){
            $('#newCapacity').attr('min','0');
            if( $('#newCapacity').val() < 0 ){
                $('#newCapacity').val(0);
            }
        });

        $('#var_cap').click(function(){
            $('#newCapacity').attr('min','-99');
        });

        $('#ending_time').datetimepicker({
            format: 'HH:mm',
            stepping: 5
        });
  });


</script>
<#include "/admin/util/editor/editor.html" />
<@initEditor type='comment' />