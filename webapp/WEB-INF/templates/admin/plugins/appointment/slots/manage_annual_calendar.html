<link rel="stylesheet" href="js/plugins/appointment/js-year-calendar.min.css">

<@row>
	<@columns>
		<@messages errors=errors warnings=warnings infos=infos />
        <@tabs params=' style="margin-top:15px"'>
            <@tabList>
                <@tabLink href='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=manageTypicalWeek&id_form=${id_form}' title='#i18n{appointment.typicalWeek.pageTitle}' active=false />
                <@tabLink href='jsp/admin/plugins/appointment/ManageSpecificWeek.jsp?view=manageSpecificWeek&id_form=${id_form}' title='#i18n{appointment.specificWeek.pageTitle}' active=false /> 			 
                <@tabLink href='jsp/admin/plugins/appointment/ManageAnnualCalendar.jsp?view=manageAnnualCalendar&id_form=${id_form}' title='#i18n{appointment.annual.calendar.pageTitle}' active=true />  			
                <#if isDeskInstalled?? && isDeskInstalled>                
                	<@tabLink href='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp?plugin_name=appointment-desk&id_form=${id_form}' title='#i18n{appointment.specificDay.pageTitle}' active=false />  
           		</#if>
            </@tabList>
            <@tabContent>
                <@row>
                    <@columns sm=10>
                        <div id="calendar"></div>
                    </@columns>
                    <@columns sm=2>
                        <@ul class="list-unstyled">
                            <#list listReservationRule as rule>
                                <@li>
                                    <span style="display:inline-block; background-color: ${rule.color};width:20px;height:12px"></span> ${rule.name} <a href="jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=manageTypicalWeek&id_form=${id_form}&id_reservation_rule=${rule.idReservationRule}"><i class="fas fa-eye fa-fw"></i></a> 
                                </@li>
                            </#list>
                        </@ul>
                    </@columns>
                </@row>
            </@tabContent>
        </@tabs>
    </@columns>
</@row>

<div id="context-menu"></div>
<@modal id='event-modal' size='md' >
	<@modalHeader modalTitle='#i18n{appointment.assign.typicalWeek.defaultTitle}' />
	<@modalBody>
		<@tform id='form-validate' action='jsp/admin/plugins/appointment/ManageAnnualCalendar.jsp' params='enctype="multipart/form-data"'>
			<@input type='hidden' name='action' value='doAssignWeek' />
			<@input type='hidden' name='id_form' value='${id_form}' />
			<@input type='hidden' name='id_week_definition' value='' />
			<@formGroup labelFor='date_of_apply' labelKey='#i18n{appointment.manageAppointments.startingDateOfSearch}'>
				<@inputGroup>
					<@input type='text' name='date_of_apply' id='date_of_apply' value="" />
					<@inputGroupItem type='text'>
						<@icon style='calendar' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='endingDate' labelKey='#i18n{appointment.manageAppointments.endingDateOfSearch}'>
				<@inputGroup>
					<@input type='text' name='ending_date_of_apply' id='ending_date_of_apply' value="" />
					<@inputGroupItem type='text'>
						<@icon style='calendar' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>	
			<@formGroup labelFor='type' labelKey='#i18n{appointment.week.toApplay}'>
				<select name="id_reservation_rule" id="id_reservation_rule" class="form-control">
                <#list listReservationRule as rule>
				    <option value="${rule.idReservationRule}">${rule.name}</option>
                </#list>
				</select>
			</@formGroup>		
			<@formGroup rows=2 class="text-center">
                <@button type='submit' name='save' id='save' buttonIcon='check' title='#i18n{appointment.labelSave}' />
                <@button type='submit' name='delete' id='delete' title='#i18n{portal.util.labelDelete}' buttonIcon='trash' color='danger'  />
                 <@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />   
			</@formGroup>	
		</@tform>
	</@modalBody>
</@modal>

<script src="js/plugins/appointment/js-year-calendar.js"></script>
<script src="js/plugins/appointment/locales/js-year-calendar.fr.js"></script>
<script src="js/bootstrap-datepicker.min.js"></script>
<script src="js/locales/bootstrap-datepicker.fr.js" ></script>
<script>
function isOlderThanToday( dtCompare ) {    
    var dateToday = new Date().setUTCHours( 0, 0, 0, 0); // Today
    console.log( dateToday );
    var isOlder=dtCompare.setUTCHours( 24, 0, 0, 0) >= dateToday ? true : false; 
    console.log( dtCompare.setUTCHours( 0, 0, 0, 0) );
    return isOlder;   
}    

let calendar = null;
function editEvent( event) {
    if( event.weekDef != undefined  ){
        $('#event-modal input[name="id_week_definition"]').val( event.weekDef );
        $('#event-modal #delete').show();
        if( !isOlderThanToday( event.startDate ) ){
            $('#event-modal #delete').attr('disabled','disabled');
        } else {
            $('#event-modal #delete').removeAttr('disabled');
        }
    } else {
        $('#event-modal #delete').hide();
    }
    $('#event-modal input[name="date_of_apply"]').datepicker({'language':'fr'}).datepicker('update', event ? event.startDate : '');
    $('#event-modal input[name="ending_date_of_apply"]').datepicker({'language':'fr'}).datepicker('update', event ? event.endDate : '');
    $('#event-modal').modal();
}

function deleteEvent(event) {
   location.href= 'jsp/admin/plugins/appointment/ManageAnnualCalendar.jsp?action=doUnssignWeek&id_week_definition='+event.idweekdef+'&id_form=${id_form}';
}

$(function() {
    calendar = new Calendar('#calendar', { 
        language: 'fr',
        startYear: ${start_year},
        enableContextMenu: true,
        enableRangeSelection: true,
        contextMenuItems:[
            {
                text: 'Modifier',
                click: editEvent
            },
            {
                text: 'Supprimer',
                click: deleteEvent
            }
        ],
        selectRange: function(e) {
            if ( e.events.length > 0 ){
                editEvent({ startDate: e.startDate, endDate: e.endDate, weekDef: e.events[0].idweekdef });
            } else {
                editEvent({ startDate: e.startDate, endDate: e.endDate });
            }
        },
        mouseOnDay: function(e) {
            if(e.events.length > 0) {
                var content = '';
                for(var i in e.events) {
                    content += '<div class="event-tooltip-content">'
                            + '<div class="event-name" style="color:' + e.events[i].color + '">' + e.events[i].name + '</div>'
                            + '<div class="event-location">' + e.events[i].location + '</div>'
                            + '</div>';
                }
                $(e.element).popover({ 
                    trigger: 'manual',
                    container: 'body',
                    html:true,
                    content: content
                });
                $(e.element).popover('show');
            }
        },
        mouseOutDay: function(e) {
            if(e.events.length > 0) {
                $(e.element).popover('hide');
            }
        },
        dayContextMenu: function(e) {
            $(e.element).popover('hide');
        },
        dataSource: [
            <#list listReservationRule as rule>
                <#list listWeekDefinition?filter( weekdef -> weekdef.idReservationRule  = rule.idReservationRule ) as weekdef>
                    {
                        id: ${rule.idReservationRule},
                        name: '${rule.name}',
                        location: '${rule.descriptionRule}',
                        startDate: new Date(${weekdef.dateOfApply.year}, ${weekdef.dateOfApply.monthValue -1}, ${weekdef.dateOfApply.dayOfMonth}),
                        endDate: new Date(${weekdef.endingDateOfApply.year}, ${weekdef.endingDateOfApply.monthValue -1}, ${weekdef.endingDateOfApply.dayOfMonth!}),
                        color: '${rule.color}',
                        idweekdef: ${weekdef.idWeekDefinition},
                    },
                </#list>
            </#list>
        ]
    });

    $('#event-modal #delete').click(function( em ) {
        $('#event-modal input[name="action"]').val( 'doUnssignWeek' );
    })
});
$('.content-header > h1 > small').html( "${appointmentform.title}" );
</script>